<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Kingdom 3584 KvK Tracker</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Authentication Check -->
    <script>
        // Check authentication before loading page
        const adminToken = localStorage.getItem('admin_token');
        const adminUsername = localStorage.getItem('admin_username');

        if (!adminToken) {
            // No token, redirect to login
            window.location.href = 'admin-login.html';
        }

        // TODO: Optionally verify token with backend
        // For now, just check if token exists
    </script>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>âš™ï¸ Admin Panel</h1>
            <p>Kingdom 3584 â€¢ Data Management</p>
            <div style="display: flex; gap: 15px; align-items: center; justify-content: center; margin-top: 10px;">
                <span id="admin-username-display" style="color: #10b981;"></span>
                <a href="dashboard.html" class="back-link">â† Back to Dashboard</a>
                <button id="logout-btn" class="back-link" style="background: none; border: 1px solid #ef4444; color: #ef4444; padding: 5px 15px; border-radius: 6px; cursor: pointer;">ğŸšª Logout</button>
            </div>
        </header>

        <!-- Season Management -->
        <section class="admin-section">
            <h2>ğŸ† Season Management</h2>
            <div id="season-management" class="season-management">
                <div class="loading">Loading seasons...</div>
            </div>
        </section>

        <!-- Fight Period Management -->
        <section class="admin-section" style="border: 2px solid #10b981; border-radius: 12px; padding: 25px;">
            <h2>âš”ï¸ Fight Period Management</h2>
            <p class="section-desc" style="color: #6ee7b7;">
                Mark time periods when real KvK fights occur. System will calculate <strong>Real Fight KP</strong> (combat contribution) separately from trading KP.
            </p>

            <!-- Active Season Display -->
            <div id="fight-period-season-info" class="season-info-box" style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div class="loading">Loading active season...</div>
            </div>

            <!-- Fight Periods List -->
            <div id="fight-periods-list" class="fight-periods-list">
                <div class="loading">Loading fight periods...</div>
            </div>

            <!-- Create Fight Period Form -->
            <div id="create-fight-form-container" style="display: none; margin-top: 25px; padding-top: 25px; border-top: 1px solid rgba(16, 185, 129, 0.3);">
                <h3>â• Create New Fight Period</h3>
                <form id="create-fight-form">
                    <div class="form-group">
                        <label for="fight-number">Fight Number *</label>
                        <input type="number" id="fight-number" min="1" required
                               placeholder="1, 2, 3...">
                    </div>

                    <div class="form-group">
                        <label for="fight-name">Fight Name *</label>
                        <input type="text" id="fight-name" required
                               placeholder="e.g., Pass 1 - Kingdom 1234">
                    </div>

                    <div class="form-group">
                        <label for="fight-start-time">Start Time *</label>
                        <input type="datetime-local" id="fight-start-time" required>
                        <small style="color: #6ee7b7; margin-top: 5px; display: block;">
                            When did the fight start?
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="fight-end-time">End Time (optional)</label>
                        <input type="datetime-local" id="fight-end-time">
                        <small style="color: #6ee7b7; margin-top: 5px; display: block;">
                            Leave empty for ongoing fights. You can set this later.
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="fight-description">Description (optional)</label>
                        <textarea id="fight-description" rows="2"
                                  placeholder="e.g., First major battle of KvK 6"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="upload-btn" style="background: #10b981;">
                            âš”ï¸ Create Fight Period
                        </button>
                        <button type="button" id="cancel-fight-btn" class="back-link"
                                style="padding: 10px 20px;">
                            Cancel
                        </button>
                    </div>
                </form>
                <div id="create-fight-message"></div>
            </div>

            <!-- Toggle Create Form Button -->
            <button id="toggle-create-fight-btn" class="upload-btn"
                    style="background: #10b981; margin-top: 20px;">
                â• Create New Fight Period
            </button>
        </section>

        <!-- Final KvK Data Upload -->
        <section class="admin-section" style="border: 2px solid #7c3aed; border-radius: 12px; padding: 25px;">
            <h2>ğŸ† Final KvK Data Upload (End of KvK)</h2>
            <p class="section-desc" style="color: #c4b5fd;">
                <strong>Use this at the END of KvK</strong> to upload comprehensive final data in one file:
                account classification, farm linking, and verified deaths.
            </p>

            <!-- Upload Form -->
            <form id="final-kvk-form">
                <div class="form-group">
                    <label for="final-kvk-file">Select Final KvK Excel File</label>
                    <input type="file" id="final-kvk-file" accept=".xlsx,.xls">
                    <small style="color: #c4b5fd; margin-top: 5px; display: block;">
                        Required columns: governor_id, account_type, linked_to_main, t4_deaths, t5_deaths, notes
                    </small>
                </div>
                <button type="submit" class="upload-btn final-kvk-btn">
                    ğŸ† Upload Final KvK Data
                </button>
            </form>
            <div id="final-kvk-message"></div>

            <!-- Upload Results -->
            <div id="final-kvk-results" style="display: none; margin-top: 20px;">
                <h3>Final Upload Results</h3>
                <div id="final-kvk-results-content"></div>
            </div>

            <!-- Mark Complete Button -->
            <div id="mark-complete-section" style="display: none; margin-top: 25px; padding-top: 25px; border-top: 1px solid rgba(124, 58, 237, 0.3);">
                <h3>Mark Season as Completed</h3>
                <p class="section-desc">After uploading final data, mark the season as completed to prepare for archiving.</p>
                <button id="mark-complete-btn" class="upload-btn mark-complete-btn">
                    âœ… Mark Season as Completed
                </button>
                <div id="mark-complete-message"></div>
            </div>
        </section>

        <!-- Verified Deaths Upload -->
        <section class="admin-section">
            <h2>ğŸ’€ Upload Verified Deaths (T4/T5 Breakdown)</h2>
            <p class="section-desc">Upload verified T4 and T5 death data progressively during KvK.</p>

            <!-- Verification Status -->
            <div id="verification-status" class="verification-status">
                <div class="loading">Loading verification status...</div>
            </div>

            <!-- Upload Form -->
            <form id="verified-deaths-form">
                <div class="form-group">
                    <label for="verified-deaths-file">Select Excel File</label>
                    <input type="file" id="verified-deaths-file" accept=".xlsx,.xls">
                    <small style="color: #94a3b8; margin-top: 5px; display: block;">
                        Required columns: governor_id, t4_deaths, t5_deaths, notes (optional)
                    </small>
                </div>
                <button type="submit" class="upload-btn verified-deaths-btn">
                    ğŸ’€ Upload Verified Deaths
                </button>
            </form>
            <div id="verified-deaths-message"></div>

            <!-- Upload Results Preview -->
            <div id="verified-deaths-results" style="display: none; margin-top: 20px;">
                <h3>Upload Results</h3>
                <div id="verified-deaths-results-content"></div>
            </div>
        </section>

        <!-- Player Classification -->
        <section class="admin-section">
            <h2>ğŸ‘¥ Player Classification & Farm Linking</h2>
            <div id="player-classification" class="player-classification">
                <div class="loading">Loading players...</div>
            </div>
        </section>

        <!-- Data Status -->
        <section class="admin-section">
            <h2>ğŸ“Š Data Status</h2>
            <div id="data-status" class="data-status">
                <div class="loading">Checking data status...</div>
            </div>
        </section>

        <!-- Baseline Upload -->
        <section class="admin-section">
            <h2>ğŸ“ Upload Baseline (Start of KvK)</h2>
            <p class="section-desc">Upload this ONCE at the start of KvK. This is the reference point for all comparisons.</p>
            <p class="section-desc" style="color: #10b981; font-size: 0.9rem;">âœ¨ Now supports direct Excel (.xlsx) upload from Hero Scrolls!</p>

            <form id="baseline-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="baseline-file">Select File (CSV or Excel)</label>
                        <input type="file" id="baseline-file" accept=".csv,.xlsx,.xls">
                    </div>
                    <div class="form-group">
                        <label for="baseline-season">KvK Season ID</label>
                        <input type="text" id="baseline-season" value="season_1">
                    </div>
                </div>
                <button type="submit" class="upload-btn baseline-btn">
                    ğŸ“ Upload Baseline
                </button>
            </form>
            <div id="baseline-message"></div>
        </section>

        <!-- Current Data Upload -->
        <section class="admin-section">
            <h2>ğŸ“¤ Upload Current Data (After Each Fight)</h2>
            <p class="section-desc">Upload this after each fight to update the leaderboard. Deltas will be calculated from baseline.</p>
            <p class="section-desc" style="color: #10b981; font-size: 0.9rem;">âœ¨ Now supports direct Excel (.xlsx) upload from Hero Scrolls!</p>

            <form id="current-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="current-file">Select File (CSV or Excel)</label>
                        <input type="file" id="current-file" accept=".csv,.xlsx,.xls">
                    </div>
                    <div class="form-group">
                        <label for="current-season">KvK Season ID</label>
                        <input type="text" id="current-season" value="season_1">
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">Description (e.g., "After Pass 4 Fight")</label>
                    <input type="text" id="description" placeholder="After Pass 4 Fight">
                </div>
                <button type="submit" class="upload-btn current-btn">
                    ğŸ“¤ Upload Current Data
                </button>
            </form>
            <div id="current-message"></div>
        </section>

        <!-- File Management -->
        <section class="admin-section">
            <h2>ğŸ“ File Management</h2>
            <p class="section-desc">View and manage all uploaded files. You can delete individual entries here.</p>

            <!-- Baseline Files Table -->
            <div class="file-management-section">
                <h3>ğŸ¯ Baseline Data</h3>
                <div id="baseline-files-table" class="files-table">
                    <div class="loading">Loading baseline files...</div>
                </div>
            </div>

            <!-- Current Data Files Table -->
            <div class="file-management-section" style="margin-top: 30px;">
                <h3>ğŸ“Š Current Data / History</h3>
                <div id="history-files-table" class="files-table">
                    <div class="loading">Loading history files...</div>
                </div>
            </div>
        </section>

        <!-- Upload History (Keep for backward compatibility) -->
        <section class="admin-section" style="display: none;">
            <h2>ğŸ“œ Upload History</h2>
            <p class="section-desc">All data uploads for this KvK season.</p>
            <div id="history-list" class="history-list">
                <div class="loading">Loading history...</div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Admin Panel â€¢ Kingdom 3584 â€¢ ML-Powered Data Processing</p>
        </footer>
    </div>

    <script src="utilities.js"></script>
    <script src="admin.js"></script>
</body>
</html>